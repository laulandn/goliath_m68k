/*  Metrowerks Standard Library  *//*  $Date: 2000/07/28 17:01:18 $  *  $Revision: 1.7.2.1 $  *  $NoKeywords: $  * *		Copyright © 1995-1999 Metrowerks, Inc. *		All rights reserved. *//* *	startup.win32.c *	 *	Routines *	-------- * 		_CRTStartup */#include "critical_regions.h"#include "crtl.h"#define WIN32_LEAN_AND_MEAN#include <windows.h>/*#include <cstdlib> *//*#include <cstdarg> *//*#include <cwchar>  *//* All the environment varible strings packed together. An empty string * signals the end of the list. For example: * "VARA=53\0TEMP=C:\\TEMP\0\0"	*/char *(*environ) = 0;char **_Environ;		/* vss 981210 */ /* mm 990115 *///void _CRTStartup(int);          /* hh 971206  mismatched prototype */// used in abort_exit.c to get counter -- needed for DLL interfaceint *__get_MSL_init_count(void);int *__get_MSL_init_count(void){	static int __MSL_init_count = 0;			/* blc 980812 */	return &__MSL_init_count;}void _CRTStartup(){	HANDLE handle;	HANDLE msl_handle;    char *theEnvStrings;    char *origEnvStrings;		/* gcm 980828  */	char *CurEnvStringP;	static char * MyEnvStrings;	int  envVars = 0;		/* vss 990507 */	int 	i;	char 	*tmpEnv;    /* Only initialize once, since we might be called by DLLs and the main */    if ((*__get_MSL_init_count())++) return;	/* blc 980811 */	__init_critical_regions();  	   	/* Set up stdin stdout and stderr */	 	_HandleTable[0] = (FileStruct *)malloc(sizeof(FileStruct));	if (_HandleTable[0])	{		handle = GetStdHandle(STD_INPUT_HANDLE);				// Duplicate the standard handle, don't copy it.		// This allows us to close it properly at shutdown.		if (__dup_core(handle, &msl_handle) != NO_ERROR)			_HandleTable[0]->handle = INVALID_HANDLE_VALUE;				else		    _HandleTable[0]->handle = msl_handle;		    	   	 _HandleTable[0]->translate = 1;	/* 961208 KO */	   	_HandleTable[0]->append = 0;	}	_HandleTable[1] = (FileStruct *)malloc(sizeof(FileStruct));	if (_HandleTable[1])	{		handle = GetStdHandle(STD_OUTPUT_HANDLE);				// Duplicate the standard handle, don't copy it.		// This allows us to close it properly at shutdown.		if (__dup_core(handle, &msl_handle) != NO_ERROR)			_HandleTable[1]->handle = INVALID_HANDLE_VALUE;				else		    _HandleTable[1]->handle = msl_handle;	    _HandleTable[1]->translate = 1;	/* 961208 KO */	    _HandleTable[1]->append = 0;	}	_HandleTable[2] = (FileStruct *)malloc(sizeof(FileStruct));	if (_HandleTable[2])	{		handle = GetStdHandle(STD_ERROR_HANDLE);				// Duplicate the standard handle, don't copy it.		// This allows us to close it properly at shutdown.		if (__dup_core(handle, &msl_handle) != NO_ERROR)			_HandleTable[2]->handle = INVALID_HANDLE_VALUE;				else		    _HandleTable[2]->handle = msl_handle;		 _HandleTable[2]->translate = 1;	/* 961208 KO */	    _HandleTable[2]->append = 0;	}		/* Next available handle is 3 */		_HandPtr = 3;		/* Set up the global pointer to the list of environment variable strings */	origEnvStrings = theEnvStrings = GetEnvironmentStrings();  /* gcm  980828 */	/* Skip special symbols beginning with '=' */	/*theEnvStrings = GetEnvironmentStrings();  ???*/	while (*theEnvStrings == '=')	{    	theEnvStrings += strlen(theEnvStrings) + 1;	}	/* Now, find out how long it is */	CurEnvStringP = theEnvStrings;	while (*CurEnvStringP)	{	    CurEnvStringP += strlen(CurEnvStringP)+1;	}	/* Make a copy of it */	MyEnvStrings = (char *)malloc(CurEnvStringP-theEnvStrings + 1);		if (MyEnvStrings) {		memcpy(MyEnvStrings, theEnvStrings, CurEnvStringP-theEnvStrings + 1);	}		environ = &MyEnvStrings;		/* vss  981210  Set up char array pointers to each environment string in Environ */	tmpEnv = *environ;	while (*tmpEnv)  /*  vss 990507  */	{		envVars++;		tmpEnv += strlen(tmpEnv) + 1;	}	_Environ = malloc((envVars+1) * sizeof(char *));  /*  get space for pointers */ 	tmpEnv = *environ;   	i = 0; 	while (*tmpEnv) 	{		_Environ[i++] = tmpEnv;		tmpEnv += strlen(tmpEnv) + 1; 	} 		_Environ[i] = 0;  /*  set end of array to NULL */	/* assert(i == envVars); */	FreeEnvironmentStrings(origEnvStrings);	/* gcm 980828 */	}/* Change History961208 KO	Initialized the translate field in the FileStructs for stdin, stdout,			and stderr. Now EOLs should always be properly converted between			'\n's.961216 KO	Changed the initialization of environ. Now the strings are no longer			converted to uppercase (getenv doesn't rely on that so there			is no reason to). Made the global Initialized local to _CRTStartup.hh 980122   Replaced <windows.h> with the following TWO includes because it is seriously            broken.  The following 2 includes must be carefully ordered as shown, because            they are broken too.* mf/blc 980810   Fix to x86 runtime dll crash(when > 1 dll is attached to MSL)* gcm 980828 Free env strings - fixes a memory leak when loading and unloading*            multiple dll's.* vss 981210 Want the Environ string to actually be an array of pointers to environ strings* mm  990115 Changed Environ to _Environ* vss 990507 Clean up the code a bit* blc 991007 Fixed memory leak by dropping call to GetEnvironmentStrings()*  cc 000515 Fixed #include*  cc 000712 Added JC fix validate the handle via GetHandleInformation().*  cc 000714 Added JC Fix to check for valid handle .* ejs 000724 Reverted JC's fixes and duplicated the standard handles instead.*            GetHandleInformation() doesn't accept console handles (as passed under cygwin)*            until Win2000.  Also, duplicating allows us to close the handle at shutdown.*            It's not clear whether an application is allowed to close a standard handle.*/