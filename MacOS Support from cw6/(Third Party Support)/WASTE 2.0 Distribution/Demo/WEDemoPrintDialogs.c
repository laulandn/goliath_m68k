/* *	WASTE Demo Project: *	Print dialogs * *	Copyright © 1993-2000 Marco Piovanelli *	All Rights Reserved * *	C port by John C. Daub * *	<mailto:waste@merzwaren.com> *	<http://www.merzwaren.com/waste/> *///	Mac OS #includes#ifndef __SOUND__#include <Sound.h>#endif//	WASTE Demo #includes#include "WEDemo.h"#ifndef __MEASURES__#include "Measures.h"#endif//	dialog item numbersenum{	kItemTopField			=	1,	kItemBottomField		=	2,	kItemLeftField			=	3,	kItemRightField			=	4,	kItemFirstField			=	kItemTopField,	kItemLastField			=	kItemRightField} ;typedef struct PrCallbackData{	DialogRef				theDialog ;				//	reference to page setup or print dialog	ModalFilterUPP			origFilterProc ;		//	original event filter	UserItemUPP				origItemProc ;			//	original item handler function	Fixed					margins [ 4 ] ;			//	page margins	SInt16					additionalItemsID ;		//	ID of DITL resource for extra items	SInt16					numItems ;				//	count of original items in dialog	UnitCode				preferredUnit ;			//	preferred unit for numeric values	SInt16					recentEditField ;		//	most recently active edit field} PrCallbackData ;//	static variablesstatic PrCallbackData *			sPrCallbackData ;static void SetMarginField ( SInt16 inWhichSide, Fixed inMargin, PrCallbackData * inData ){	Str255	theString ;	if ( MeasureToString ( inMargin, inData -> preferredUnit, theString ) == noErr )	{		SetEditFieldString ( inData -> theDialog, inWhichSide + inData -> numItems + kItemFirstField, theString ) ;	}}static OSStatus GetMarginField ( SInt16 inWhichSide, Fixed * outMargin, PrCallbackData * inData ){	Str255	theString ;	GetEditFieldString ( inData -> theDialog, inWhichSide + inData -> numItems + kItemFirstField, theString ) ;	return StringToMeasure ( theString, inData -> preferredUnit, outMargin ) ;}static pascal Boolean FilterPrintDialogEvent ( DialogRef inDialog, EventRecord * ioEvent, SInt16 * ioItem ){	ModalFilterUPP filter = GetMyStandardDialogFilter ( ) ;	//	we first call our own filter, then (if the event wasn't handled), the original filter proc	if ( CallModalFilterProc ( filter, inDialog, ioEvent, ioItem ) )	{		return true ;	}	if ( ( filter = sPrCallbackData -> origFilterProc ) != nil )	{		return CallModalFilterProc ( filter, inDialog, ioEvent, ioItem ) ;	}	return false ;}static pascal void HandlePrintDialogItem ( DialogRef inDialog, SInt16 inItem ){	PrCallbackData *	data = sPrCallbackData ;	Fixed				margin ;	SInt16				whichSide ;	//	if one of the standard items was hit, call the original handler	if ( ( inItem <= data -> numItems ) && ( data -> origItemProc != nil ) )	{		CallUserItemProc ( data -> origItemProc, inDialog, inItem ) ;	}	//	if one of our edit fields has just been exited, check its contents	if ( ( inItem > 0 ) && ( inItem != data -> recentEditField ) )	{		whichSide = ( data -> recentEditField - data -> numItems ) - kItemFirstField ;		//	make sure we only validate our own fields		if ( ( whichSide >= 0 ) && ( whichSide <= 3 ) )		{			if ( GetMarginField ( whichSide, & margin, data ) != noErr )			{				//	bad string: put the old string back and select the bad field				SysBeep ( 0 ) ;				SetMarginField ( whichSide, data -> margins [ whichSide ], data ) ;				SelectDialogItemText ( inDialog, data -> recentEditField, 0, 0x7FFF ) ;			}			else			{				//	if the string is valid, save the margin value				data -> margins [ whichSide ] = margin ;			}		}		//	remember current edit field		data -> recentEditField = GetDialogKeyboardFocusItem ( inDialog ) ;	}}static TPPrDlgRef InitPrintDialog ( THPrint ){	static ModalFilterUPP		eventFilter = nil ;	static UserItemUPP			itemHandler = nil ;	PrCallbackData *			data = sPrCallbackData ;	TPrDlg *					prDialog = ( TPrDlg * ) data -> theDialog ;	Handle						additionalItems ;	SInt16						whichSide ;	if ( eventFilter == nil )	{		eventFilter = NewModalFilterProc ( FilterPrintDialogEvent ) ;	}	if ( itemHandler == nil )	{		itemHandler = NewUserItemProc ( HandlePrintDialogItem ) ;	}	//	save original event filter and item handler functions	data -> origFilterProc = prDialog -> pFltrProc ;	data -> origItemProc = prDialog -> pItemProc ;	//	count dialog items	data -> numItems = CountDITL ( data -> theDialog ) ;	//	install our own event filter	prDialog -> pFltrProc = eventFilter ;	if ( data -> additionalItemsID != 0 )	{		//	additional processing for the page setup dialog		//	install our own item handler		prDialog -> pItemProc = itemHandler ;		//	get additional item list		if ( ( additionalItems = GetResource ( kTypeDialogItemList, data -> additionalItemsID ) ) != nil )		{			//	append the extra items at the bottom of the standard dialog			DetachResource ( additionalItems ) ;			AppendDITL ( data -> theDialog, additionalItems, appendDITLBottom ) ;			DisposeHandle ( additionalItems ) ;			//	the default unit is in (US) or cm (metric world)			data -> preferredUnit = IsMetric ( ) ? kUnitCentimeter : kUnitInch ;			//	fill in the margin edit fields			for ( whichSide = 0 ; whichSide < 4 ; whichSide ++ )			{				SetMarginField ( whichSide, data -> margins [ whichSide ], data ) ;			}		}	}	return prDialog ;}Boolean DoPrintDialog ( THPrint inPrintRecord, PageMarginRecHandle inMargins, PrintDialogStyle inStyle ){	static PDlgInitUPP		initer = nil ;	PrCallbackData			data ;	Boolean					dialogResult ;	if ( initer == nil )	{		initer = NewPDlgInitProc ( InitPrintDialog ) ;	}	//	prepare parameter block for callbacks	BlockZero ( & data, sizeof ( data ) ) ;	sPrCallbackData = & data ;	switch ( inStyle )	{		case kPrintDialog :		{			data . theDialog = ( DialogRef ) PrJobInit ( inPrintRecord ) ;			break ;		}		case kPageSetupDialog :		{			data . theDialog = ( DialogRef ) PrStlInit ( inPrintRecord ) ;			data . additionalItemsID = kDITLPageSetupExtras ;			if ( inMargins )			{				BlockMoveData ( * inMargins, & data . margins, sizeof ( PageMarginRec ) ) ;			}			break ;		}	}	if ( data . theDialog == nil )	{		return false ;		//	emergency exit	}	//	display the dialog	dialogResult = PrDlgMain ( inPrintRecord, initer ) ;	//	if the dialog was accepted, copy back the modified margins	if ( dialogResult && inMargins )	{		BlockMoveData ( & data . margins, * inMargins, sizeof ( PageMarginRec ) ) ;	}	return dialogResult ;}