/* *	StartupApp.c		-	init/startup/termination routines for Metrowerks C++ (PowerPC) * *	Copyright © 1995-2000 Metrowerks, Inc. All Rights Reserved. * * *	THEORY OF OPERATION * *	This version of the PPC startup code is intended to be used for multi-fragment *	applications. It is designed to properly support exceptions thrown across fragment *	boundaries, and proper initialization and termination--including construction and *	destruction of static objects--for all fragments that make up the program. * *	The startup file defines 3 entry-points: * *		__start			This must be the Main Entry-Point for the Application. *						__start() calls main(), and then calls exit() *						to terminate the program. * *		__initialize	This must be the Initialization Entry-Point for the Application. *						__initialize() registers the exception-handling info for *						the application, and calls all static initializers. * *		__terminate		This must be the Termination Entry-Point for the Application *						__terminate() unregisters the exception-handling info for the *						shared application before the fragment is unloaded. * *	The new zero-runtime-overhead exception-handling mechanism requires that we *	keep track of all loaded fragments and their code/data section ranges--we *	cannot use the OS data structures to do this--so we must call routines which *	register and unregister the exception-handling info as a fragment is loaded/unloaded. * *	The exit() routine will handle all termination responsibilities in the proper *	order. In particular, it will call all atexit() routines before destroying any *	static objects, and it will clean up the I/O and console packages after *	destroying all static objects. * */#include <CodeFragments.h>#include <Types.h>#include <stdlib.h>#include <NMWException.h>	/*	external data	*/extern char __code_start__[];				/*	(defined by linker)	*/extern char	__code_end__[];					/*	(defined by linker)	*/extern char __data_start__[];				/*	(defined by linker)	*/extern char __data_end__[];					/*	(defined by linker)	*/extern char __exception_table_start__[];	/*	(defined by linker)	*/extern char __exception_table_end__[];		/*	(defined by linker)	*/	/*	private data	*/static int fragmentID;						/*	ID given to fragment by exception-handling	*/	/*	prototypes	*/#ifdef __cplusplusextern "C" {#endifint main(int argc, char **argv);void __sinit(void);	/*	(generated by linker)	*/pascal OSErr __initialize(const CFragInitBlock *theInitBlock);pascal void __terminate(void);pascal void __start(void);#ifdef __cplusplus}#endif/* *	clear_stackframe_backlink	-	set 0(SP) to 0 * */static asm void clear_stackframe_backlink(void){		li		r3,0		stw		r3,0(SP)	#if !defined(__MWERKS__)			blr	#endif}/* *	__RTOC	-	return the TOC pointer for our code fragment * */static asm char *__RTOC(void){		mr		r3,RTOC	#if !defined(__MWERKS__)			blr	#endif}/* *	__initialize	-	Default initialization routine for Metrowerks C++ (PowerPC) * *	This routine should be specified as the PEF initialization routine in the container *	for any multi-fragment application. * */pascal OSErr __initialize(const CFragInitBlock *theInitBlock){#pragma unused(theInitBlock)	//	register this code fragment with the Exception Handling mechanism	fragmentID = __register_fragment(__code_start__, __code_end__,									__data_start__, __data_end__,									__exception_table_start__, __exception_table_end__,									__RTOC());		//	call all static initializers	__sinit();		//	return success to Code Fragment Manager	return(noErr);}/* *	__start	-	Default startup routine for Metrowerks C++ (PowerPC) * *	This routine should be specified as the PEF main routine in the container *	for any multi-fragment application. * *	We defer all details of proper program termination to the ANSI exit() routine. * */pascal void __start(void){	char *argv = 0;	//	set the stack frame back-link to 0 to improve debugger stack display	clear_stackframe_backlink();		//	call main(argc, argv)	main(0, &argv);		//	call exit() to terminate the program properly--will not return	exit(0);}/* *	__terminate	-	Default termination routine for Metrowerks C++ (PowerPC) * *	This routine should be specified as the PEF termination routine in the container *	for any multi-fragment application. * */pascal void __terminate(void){	//	unregister this code fragment with the Exception Handling mechanism	__unregister_fragment(fragmentID);}