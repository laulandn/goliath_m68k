/*  Metrowerks Standard Library  *//*  $Date: 2000/06/27 14:52:19 $  *  $Revision: 1.4.10.6 $  *  $NoKeywords: $  * *		Copyright © 1995-2000 Metrowerks, Inc. *		All rights reserved. *//* *	File:		fcntl.c * *	Content:	Interface file to standard UNIX-style entry points ... * *	NB:			This file implements some UNIX low level support.  These functions *				are not guaranteed to be 100% conformant. * */#include <fcntl.h>#include <errno.h>#include <unistd.h>#include <Aliases.h>#include <Errors.h>#include <Files.h>#include <Finder.h>#include <LowMem.h>#include <MacTypes.h>	/*  990421 vss  */#include "abort_exit.h"/* function prototypes for externally defined functions */extern int	__system7present(void);extern int	__ctopstring(const char *cstring, Str255 pstring);extern long __getcreator(long isbinary);extern long __gettype(long isbinary);/* *	int open(const char *path, int oflag) *	 *		Opens a file stream. */int _open(const char *path, int oflag, ...)  /*  vss 980729  */{	Str255			pname;	FSSpec			spec;	char			permission;	HParamBlockRec	hpb;	OSErr			err;	/* Ensure that exactly one of O_RDONLY, O_RDWR, O_WRONLY is set */   /* mm 980923 */	if ((((oflag & O_RDONLY)!=0) + ((oflag & O_RDWR)!=0) + ((oflag & O_WRONLY)!=0)) != 1)		return (-1);	/* Reject POSIX undefined combinations */                            	if ((oflag & O_RDONLY) && (oflag & O_TRUNC))   		return (-1);			/* convert the c string into a pascal string */	if (__ctopstring(path, pname) != noErr) return (-1);	/* Setup permission */	if ((oflag & 0x07) == O_RDWR)             /* mm 980417 */         		permission = fsRdWrPerm;	else		permission = (oflag & O_RDONLY) ? fsRdPerm : 0 + (oflag & O_WRONLY) ? fsWrPerm : 0;	/* If System 7 is present, then try to resolve a possible alias */	if (__system7present()) {		Boolean targetIsFolder, wasAliased;		FSMakeFSSpec(0,0,pname,&spec);		if ((oflag & (O_ALIAS | O_NRESOLVE)) == 0)			ResolveAliasFile(&spec, true, &targetIsFolder, &wasAliased);		hpb.fileParam.ioNamePtr = spec.name;		hpb.fileParam.ioVRefNum = spec.vRefNum;		hpb.fileParam.ioDirID = spec.parID;		hpb.ioParam.ioPermssn = permission;		if (oflag & O_RSRC)			/* open the resource fork of the file */			err = PBHOpenRFSync(&hpb);		else						/* open the data fork of the file */			err = PBHOpenDFSync(&hpb);	} 	else 	{		/* Try to open the file */		hpb.fileParam.ioDirID = 0;		hpb.fileParam.ioVRefNum = 0;		hpb.fileParam.ioNamePtr = pname;		hpb.ioParam.ioPermssn = permission;		if (oflag & O_RSRC)			/* open the resource fork of the file */	#if TARGET_API_MAC_CARBON			err = PBHOpenRFSync(&hpb);	#else			err = PBOpenRFSync((ParmBlkPtr)&hpb);	#endif /* TARGET_API_MAC_CARBON */		else						/* open the data fork of the file */	#if TARGET_API_MAC_CARBON			err = PBHOpenDFSync(&hpb);	#else			err = PBOpenDFSync((ParmBlkPtr)&hpb);	#endif /* TARGET_API_MAC_CARBON */	}	if ((err == noErr) && (oflag & O_CREAT) && (oflag & O_EXCL))    /* mm 991210 */	{																/* mm 991210 */		err = _close(hpb.ioParam.ioRefNum);							/* mm 991210 */		return(-1);													/* mm 991210 */	}																/* mm 991210 */	if ((err == fnfErr) && (oflag & O_CREAT)) 	{		hpb.fileParam.ioFlVersNum = 0;		err = PBHCreateSync(&hpb);		if (err == noErr) {			/* Set the finder info */			unsigned long secs;			unsigned long isbinary = oflag & O_BINARY;			hpb.fileParam.ioFlFndrInfo.fdType = __gettype(isbinary);			hpb.fileParam.ioFlFndrInfo.fdCreator = __getcreator(isbinary);			hpb.fileParam.ioFlFndrInfo.fdFlags = 0;			if (oflag & O_ALIAS && __system7present())		/* set the alias bit */				hpb.fileParam.ioFlFndrInfo.fdFlags = kIsAlias;			else										/* clear all flags */				hpb.fileParam.ioFlFndrInfo.fdFlags = 0;			GetDateTime(&secs);			hpb.fileParam.ioFlCrDat = hpb.fileParam.ioFlMdDat = secs;			PBHSetFInfoSync(&hpb);		}				if (err && (err != dupFNErr)) {			errno = err; return -1;		}		if (__system7present()) {			if (oflag & O_RSRC)			/* open the resource fork of the file */				err = PBHOpenRFSync(&hpb);			else						/* open the data fork of the file */				err = PBHOpenDFSync(&hpb);		} else {			if (oflag & O_RSRC)			/* open the resource fork of the file */		#if TARGET_API_MAC_CARBON				err = PBHOpenRFSync(&hpb);		#else				err = PBOpenRFSync((ParmBlkPtr)&hpb);		#endif /* TARGET_API_MAC_CARBON */			else						/* open the data fork of the file */		#if TARGET_API_MAC_CARBON				err = PBHOpenDFSync(&hpb);		#else				err = PBOpenDFSync((ParmBlkPtr)&hpb);		#endif /* TARGET_API_MAC_CARBON */		}	}	if (err && (err != dupFNErr) && (err != opWrErr)) {		errno = err; return -1;	}	if (oflag & O_TRUNC) {		IOParam pb;				pb.ioRefNum = hpb.ioParam.ioRefNum;		pb.ioMisc = 0L;		err = PBSetEOFSync((ParmBlkPtr)&pb);		if (err != noErr) {			errno = err; return -1;		}	}	if (oflag & O_APPEND) _lseek(hpb.ioParam.ioRefNum,0,SEEK_END);		return (hpb.ioParam.ioRefNum);}/* *	int creat(char *path, mode_t mode) * *		Creates and opens a file. */int _creat(const char *path, mode_t mode){	int				omode = O_WRONLY | O_CREAT | O_TRUNC;		if (mode & O_BINARY)		omode |= O_BINARY;	return (_open(path, omode));}/* *	int fcntl(int fildes, int cmd, ...) * *		General file control routines. */int _fcntl(int fildes, int cmd, ...){	if (cmd == F_DUPFD) {		/* we don't support this one correctly but it does conform */		/* just return the same file descriptor as the one passed to it */		return (fildes);	}	return (-1);}/*  Change Record *	12/10/95 JH	Modified to interface with new ANSI C library *	15/12/95 JH Removed SetupExit call *	30/12/95 JH Removed uses of OLDROUTINENAMES *  980417   mm Change corresponding to value changes for open modes in fcntl.mac.h  MW00042 *  980729  vss Match open to POSIX standard *  mm 980923   Added code to reject illegal oflag combinations in open() *  mm 990108	Added code for umask()       MW07297 *  mm 990115	Added definition of chmod  MW06763 * vss 990421	Update to 3.2 Universal Headers *	cc 991108	added ra Carbon Changes done 990611 *  cc 991109   changed TARGET_CARBON to TARGET_API_MAC_CARBON *  cc 991115   updated and deleted outdated comments *  mm 991210   Corrected open to reject the combination O_CREAT and O_EXCL */