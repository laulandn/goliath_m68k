/*  Metrowerks Standard Library  *//*  $Date: 2000/07/11 21:17:47 $  *  $Revision: 1.8.12.3.2.1 $  *  $NoKeywords: $  * *		Copyright © 1995-1999 Metrowerks, Inc. *		All rights reserved. *//* *	File:		fcntl.c * *	Content:	Interface file to standard UNIX-style entry points ... * *	NB:			This file implements some UNIX low level support.  These functions *				are not guaranteed to be 100% conformant. * *	12/10/95 JH	Modified to interface with new ANSI C library *	15/12/95 JH Removed SetupExit call *	30/12/95 JH Removed uses of OLDROUTINENAMES *	03/12/96 KO Very minor changes to stop compiler warnings. *//* #include <x86_prefix.h>    mf  980518  */#include <cstdlib>#include <io.h> 				/* for _dup in fcntl() */#define WIN32_LEAN_AND_MEAN#include <windows.h>#include "crtl.h"#include <fcntl.h>/*#include <cerrno>*//*#include <unistd.h>*//*#include <cstdarg>*//*#include <cwchar>*//*__tls static int _doserrno;  */extern int GetHandle();/* *	int open(const char *path, int flags) * *		Opens a file stream. */int _open(const char *path, int flags,...)						/* mm 980507 */ /* mm 980710 */{    DWORD Access;	DWORD Share;	DWORD Create;	int h;	/* Ensure that exactly one of O_RDONLY, O_RDWR, O_WRONLY is set */   /* mm 980923 */	if ((((flags & O_RDONLY)!=0) + ((flags & O_RDWR)!=0) + ((flags & O_WRONLY)!=0)) != 1)		return (-1);	/* Reject POSIX undefined combination */                            	if ((flags & O_RDONLY) && (flags & O_TRUNC))   		return (-1);	/* Reject as undefined exclusive without create */  /* mm 990204  */	if ((flags & O_EXCL) && !(flags & O_CREAT))		return (-1);		/* Make sure we have a handle available */	h = GetHandle();	if (h == -1)	{	    return -1;	}	_HandleTable[h] = (FileStruct *)malloc(sizeof(FileStruct));	if (!_HandleTable[h])	{	    return -1;	}	/* Set up the translate mode flag */	_HandleTable[h]->translate = (flags & O_BINARY) == 0;	_HandleTable[h]->append = 0;	/* Make share 0 for now. */	Share = 0;	/* Get the access flags */	if (flags & O_RDONLY)	{		Share = FILE_SHARE_READ;	    Access = GENERIC_READ;	}	else if (flags & O_WRONLY)	{	    Access = GENERIC_WRITE;	}	else	{	    Access = GENERIC_READ | GENERIC_WRITE;	}	/* Get the create flags */	if (flags & O_CREAT)	{	    Create = OPEN_ALWAYS;   			/* mm 991210 */		if (flags & O_TRUNC)				/* mm 991210 */			Create = CREATE_ALWAYS; 		/* mm 991210 */	    if (flags & O_EXCL)		/*  vss 990129 implement O_EXCL flag */	    {	    	Create = CREATE_NEW;	    }	}	  	else if (flags & O_TRUNC)	{	    Create = TRUNCATE_EXISTING;	}	else	{	    Create = OPEN_EXISTING;	}	/* Do the open or create */    _HandleTable[h]->handle = CreateFile((LPCTSTR)path, (DWORD)Access, (DWORD)Share,         (LPSECURITY_ATTRIBUTES)0, (DWORD)Create, (DWORD)0, (HANDLE)0);	/* See if we suceeded */	if (_HandleTable[h]->handle != INVALID_HANDLE_VALUE)	{		/* if appending, position to the end of the file */		    if (flags & O_APPEND)	    {	        lseek(h, 0, SEEK_END);	        _HandleTable[h]->append = 1;	    }	    	    /* and return the handle */	    	    return h;	}	/* Open failed, free the FileStruct assocation with the handle */	free(_HandleTable[h]);	_HandleTable[h] = 0;	/* get error code */	_doserrno = GetLastError();		/* And return failure */	return -1;}/* *	int creat(char *path, mode_t mode) * *		Creates and opens a file. */int _creat(const char *path, mode_t mode)	/* mm 980507 */{	int				omode = O_WRONLY | O_CREAT | O_TRUNC;	if (mode & O_BINARY)		omode |= O_BINARY;	return (_open(path, omode));}/* *	int fcntl(int fildes, int cmd, ...) * *		General file control routines. */int _fcntl(int fildes, int cmd, ...)							/* mm 980507 */{	if (cmd == F_DUPFD) {		/* we don't support this one correctly but it does conform */		/* just return the same file descriptor as the one passed to it */		int __new_handle = _dup(fildes);				/* cc 000710 */		return (__new_handle);							/* cc 000710 */	}	return (-1);}														/*  Change History hh 980122  Replaced <windows.h> with the following TWO includes because it is seriously            broken.  The following 2 includes must be carefully ordered as shown, because            they are broken too. mm 980507  Changes to revert from _open, _creat, and _fcntl to open, creat, fcntl while             accommodating legacy code.  MW01597 mf 980518  x86_prefix is included by ansi_prefix.win32.h and should not be included by            wince(runs off the intel architecture). mm 980710  Changed signature for open() to match specification in POSIX standard mm 980724  Corrected mapping of open modes to match POSIX specificationvss 980825  Restored previous logic to open modes - fixed a problem with            not truncating existing files when opened with "w" permissionvss 980825  Restored C style comments vss 990129  Add O_EXCL to O_CREAT flagsmm  990204  Reject O_EXCL without O_CREAT and give O_TRUNC precedence over O_APPENDmm  991210  Prevent truncating when opening O_RDWR O_CREAT   cc  000518  fixed #include cc  000710	fixed fcntl so that you can use F_DUPFD and get a duplicate file handle*/